/**
 * Backbone-relational.js 0.8.8
 * (c) 2011-2013 Paul Uithol and contributors (https://github.com/PaulUithol/Backbone-relational/graphs/contributors)
 *
 * Backbone-relational may be freely distributed under the MIT license; see the accompanying LICENSE.txt.
 * For details and documentation: https://github.com/PaulUithol/Backbone-relational.
 * Depends on Backbone (and thus on Underscore as well): https://github.com/documentcloud/backbone.
 */
(function(e,t){if(typeof define==="function"&&define.amd){define(["exports","backbone","underscore"],t)}else if(typeof exports!=="undefined"){t(exports,require("backbone"),require("underscore"))}else{t(e,e.Backbone,e._)}})(this,function(e,t,n){"use strict";t.Relational={showWarnings:true};t.Semaphore={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable){throw new Error("Max permits acquired")}else{this._permitsUsed++}},release:function(){if(this._permitsUsed===0){throw new Error("All permits released")}else{this._permitsUsed--}},isLocked:function(){return this._permitsUsed>0},setAvailablePermits:function(e){if(this._permitsUsed>e){throw new Error("Available permits cannot be less than used permits")}this._permitsAvailable=e}};t.BlockingQueue=function(){this._queue=[]};n.extend(t.BlockingQueue.prototype,t.Semaphore,{_queue:null,add:function(e){if(this.isBlocked()){this._queue.push(e)}else{e()}},process:function(){var e=this._queue;this._queue=[];while(e&&e.length){e.shift()()}},block:function(){this.acquire()},unblock:function(){this.release();if(!this.isBlocked()){this.process()}},isBlocked:function(){return this.isLocked()}});t.Relational.eventQueue=new t.BlockingQueue;t.Store=function(){this._collections=[];this._reverseRelations=[];this._orphanRelations=[];this._subModels=[];this._modelScopes=[e]};n.extend(t.Store.prototype,t.Events,{initializeRelation:function(e,r,i){var s=!n.isString(r.type)?r.type:t[r.type]||this.getObjectByName(r.type);if(s&&s.prototype instanceof t.Relation){new s(e,r,i)}else{t.Relational.showWarnings&&typeof console!=="undefined"&&console.warn("Relation=%o; missing or invalid relation type!",r)}},addModelScope:function(e){this._modelScopes.push(e)},removeModelScope:function(e){this._modelScopes=n.without(this._modelScopes,e)},addSubModels:function(e,t){this._subModels.push({superModelType:t,subModels:e})},setupSuperModel:function(e){n.find(this._subModels,function(t){return n.filter(t.subModels||[],function(n,r){var i=this.getObjectByName(n);if(e===i){t.superModelType._subModels[r]=e;e._superModel=t.superModelType;e._subModelTypeValue=r;e._subModelTypeAttribute=t.superModelType.prototype.subModelTypeAttribute;return true}},this).length},this)},addReverseRelation:function(e){var t=n.any(this._reverseRelations,function(t){return n.all(e||[],function(e,n){return e===t[n]})});if(!t&&e.model&&e.type){this._reverseRelations.push(e);this._addRelation(e.model,e);this.retroFitRelation(e)}},addOrphanRelation:function(e){var t=n.any(this._orphanRelations,function(t){return n.all(e||[],function(e,n){return e===t[n]})});if(!t&&e.model&&e.type){this._orphanRelations.push(e)}},processOrphanRelations:function(){n.each(this._orphanRelations.slice(0),function(e){var r=t.Relational.store.getObjectByName(e.relatedModel);if(r){this.initializeRelation(null,e);this._orphanRelations=n.without(this._orphanRelations,e)}},this)},_addRelation:function(e,t){if(!e.prototype.relations){e.prototype.relations=[]}e.prototype.relations.push(t);n.each(e._subModels||[],function(e){this._addRelation(e,t)},this)},retroFitRelation:function(e){var t=this.getCollection(e.model,false);t&&t.each(function(t){if(!(t instanceof e.model)){return}new e.type(t,e)},this)},getCollection:function(e,r){if(e instanceof t.RelationalModel){e=e.constructor}var i=e;while(i._superModel){i=i._superModel}var s=n.find(this._collections,function(e){return e.model===i});if(!s&&r!==false){s=this._createCollection(i)}return s},getObjectByName:function(e){var t=e.split("."),r=null;n.find(this._modelScopes,function(e){r=n.reduce(t||[],function(e,t){return e?e[t]:undefined},e);if(r&&r!==e){return true}},this);return r},_createCollection:function(e){var n;if(e instanceof t.RelationalModel){e=e.constructor}if(e.prototype instanceof t.RelationalModel){n=new t.Collection;n.model=e;this._collections.push(n)}return n},resolveIdForItem:function(e,r){var i=n.isString(r)||n.isNumber(r)?r:null;if(i===null){if(r instanceof t.RelationalModel){i=r.id}else if(n.isObject(r)){i=r[e.prototype.idAttribute]}}if(!i&&i!==0){i=null}return i},find:function(e,t){var n=this.resolveIdForItem(e,t),r=this.getCollection(e);if(r){var i=r.get(n);if(i instanceof e){return i}}return null},register:function(e){var t=this.getCollection(e);if(t){var n=e.collection;t.add(e);e.collection=n}},checkId:function(e,n){var r=this.getCollection(e),i=r&&r.get(n);if(i&&e!==i){if(t.Relational.showWarnings&&typeof console!=="undefined"){console.warn("Duplicate id! Old RelationalModel=%o, new RelationalModel=%o",i,e)}throw new Error("Cannot instantiate more than one Backbone.RelationalModel with the same id per type!")}},update:function(e){var t=this.getCollection(e);if(!t.contains(e)){this.register(e)}t._onModelEvent("change:"+e.idAttribute,e,t);e.trigger("relational:change:id",e,t)},unregister:function(e){var r,i;if(e instanceof t.Model){r=this.getCollection(e);i=[e]}else if(e instanceof t.Collection){r=this.getCollection(e.model);i=n.clone(e.models)}else{r=this.getCollection(e);i=n.clone(r.models)}n.each(i,function(e){this.stopListening(e);n.invoke(e.getRelations(),"stopListening")},this);if(n.contains(this._collections,e)){r.reset([])}else{n.each(i,function(e){if(r.get(e)){r.remove(e)}else{r.trigger("relational:remove",e,r)}},this)}},reset:function(){this.stopListening();n.each(this._collections,function(e){this.unregister(e)},this);this._collections=[];this._subModels=[];this._modelScopes=[e]}});t.Relational.store=new t.Store;t.Relation=function(e,r,i){this.instance=e;r=n.isObject(r)?r:{};this.reverseRelation=n.defaults(r.reverseRelation||{},this.options.reverseRelation);this.options=n.defaults(r,this.options,t.Relation.prototype.options);this.reverseRelation.type=!n.isString(this.reverseRelation.type)?this.reverseRelation.type:t[this.reverseRelation.type]||t.Relational.store.getObjectByName(this.reverseRelation.type);this.key=this.options.key;this.keySource=this.options.keySource||this.key;this.keyDestination=this.options.keyDestination||this.keySource||this.key;this.model=this.options.model||this.instance.constructor;this.relatedModel=this.options.relatedModel;if(n.isFunction(this.relatedModel)&&!(this.relatedModel.prototype instanceof t.RelationalModel)){this.relatedModel=n.result(this,"relatedModel")}if(n.isString(this.relatedModel)){this.relatedModel=t.Relational.store.getObjectByName(this.relatedModel)}if(!this.checkPreconditions()){return}if(!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key){t.Relational.store.addReverseRelation(n.defaults({isAutoRelation:true,model:this.relatedModel,relatedModel:this.model,reverseRelation:this.options},this.reverseRelation))}if(e){var s=this.keySource;if(s!==this.key&&typeof this.instance.get(this.key)==="object"){s=this.key}this.setKeyContents(this.instance.get(s));this.relatedCollection=t.Relational.store.getCollection(this.relatedModel);if(this.keySource!==this.key){delete this.instance.attributes[this.keySource]}this.instance._relations[this.key]=this;this.initialize(i);if(this.options.autoFetch){this.instance.fetchRelated(this.key,n.isObject(this.options.autoFetch)?this.options.autoFetch:{})}this.listenTo(this.instance,"destroy",this.destroy).listenTo(this.relatedCollection,"relational:add relational:change:id",this.tryAddRelated).listenTo(this.relatedCollection,"relational:remove",this.removeRelated)}};t.Relation.extend=t.Model.extend;n.extend(t.Relation.prototype,t.Events,t.Semaphore,{options:{createModels:true,includeInJSON:true,isAutoRelation:false,autoFetch:false,parse:false},instance:null,key:null,keyContents:null,relatedModel:null,relatedCollection:null,reverseRelation:null,related:null,checkPreconditions:function(){var e=this.instance,r=this.key,i=this.model,s=this.relatedModel,o=t.Relational.showWarnings&&typeof console!=="undefined";if(!i||!r||!s){o&&console.warn("Relation=%o: missing model, key or relatedModel (%o, %o, %o).",this,i,r,s);return false}if(!(i.prototype instanceof t.RelationalModel)){o&&console.warn("Relation=%o: model does not inherit from Backbone.RelationalModel (%o).",this,e);return false}if(!(s.prototype instanceof t.RelationalModel)){o&&console.warn("Relation=%o: relatedModel does not inherit from Backbone.RelationalModel (%o).",this,s);return false}if(this instanceof t.HasMany&&this.reverseRelation.type===t.HasMany){o&&console.warn("Relation=%o: relation is a HasMany, and the reverseRelation is HasMany as well.",this);return false}if(e&&n.keys(e._relations).length){var u=n.find(e._relations,function(e){return e.key===r},this);if(u){o&&console.warn("Cannot create relation=%o on %o for model=%o: already taken by relation=%o.",this,r,e,u);return false}}return true},setRelated:function(e){this.related=e;this.instance.attributes[this.key]=e},_isReverseRelation:function(e){return e.instance instanceof this.relatedModel&&this.reverseRelation.key===e.key&&this.key===e.reverseRelation.key},getReverseRelations:function(e){var t=[];var r=!n.isUndefined(e)?[e]:this.related&&(this.related.models||[this.related]);n.each(r||[],function(e){n.each(e.getRelations()||[],function(e){if(this._isReverseRelation(e)){t.push(e)}},this)},this);return t},destroy:function(){this.stopListening();if(this instanceof t.HasOne){this.setRelated(null)}else if(this instanceof t.HasMany){this.setRelated(this._prepareCollection())}n.each(this.getReverseRelations(),function(e){e.removeRelated(this.instance)},this)}});t.HasOne=t.Relation.extend({options:{reverseRelation:{type:"HasMany"}},initialize:function(e){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange);var t=this.findRelated(e);this.setRelated(t);n.each(this.getReverseRelations(),function(t){t.addRelated(this.instance,e)},this)},findRelated:function(e){var t=null;e=n.defaults({parse:this.options.parse},e);if(this.keyContents instanceof this.relatedModel){t=this.keyContents}else if(this.keyContents||this.keyContents===0){var r=n.defaults({create:this.options.createModels},e);t=this.relatedModel.findOrCreate(this.keyContents,r)}if(t){this.keyId=null}return t},setKeyContents:function(e){this.keyContents=e;this.keyId=t.Relational.store.resolveIdForItem(this.relatedModel,this.keyContents)},onChange:function(e,r,i){if(this.isLocked()){return}this.acquire();i=i?n.clone(i):{};var s=n.isUndefined(i.__related),o=s?this.related:i.__related;if(s){this.setKeyContents(r);var u=this.findRelated(i);this.setRelated(u)}if(o&&this.related!==o){n.each(this.getReverseRelations(o),function(e){e.removeRelated(this.instance,null,i)},this)}n.each(this.getReverseRelations(),function(e){e.addRelated(this.instance,i)},this);if(!i.silent&&this.related!==o){var a=this;this.changed=true;t.Relational.eventQueue.add(function(){a.instance.trigger("change:"+a.key,a.instance,a.related,i,true);a.changed=false})}this.release()},tryAddRelated:function(e,t,n){if((this.keyId||this.keyId===0)&&e.id===this.keyId){this.addRelated(e,n);this.keyId=null}},addRelated:function(e,t){var r=this;e.queue(function(){if(e!==r.related){var i=r.related||null;r.setRelated(e);r.onChange(r.instance,e,n.defaults({__related:i},t))}})},removeRelated:function(e,t,r){if(!this.related){return}if(e===this.related){var i=this.related||null;this.setRelated(null);this.onChange(this.instance,e,n.defaults({__related:i},r))}}});t.HasMany=t.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:t.Collection,collectionKey:true,collectionOptions:{}},initialize:function(e){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange);this.collectionType=this.options.collectionType;if(n.isFunction(this.collectionType)&&this.collectionType!==t.Collection&&!(this.collectionType.prototype instanceof t.Collection)){this.collectionType=n.result(this,"collectionType")}if(n.isString(this.collectionType)){this.collectionType=t.Relational.store.getObjectByName(this.collectionType)}if(this.collectionType!==t.Collection&&!(this.collectionType.prototype instanceof t.Collection)){throw new Error("`collectionType` must inherit from Backbone.Collection")}var r=this.findRelated(e);this.setRelated(r)},_prepareCollection:function(e){if(this.related){this.stopListening(this.related)}if(!e||!(e instanceof t.Collection)){var r=n.isFunction(this.options.collectionOptions)?this.options.collectionOptions(this.instance):this.options.collectionOptions;e=new this.collectionType(null,r)}e.model=this.relatedModel;if(this.options.collectionKey){var i=this.options.collectionKey===true?this.options.reverseRelation.key:this.options.collectionKey;if(e[i]&&e[i]!==this.instance){if(t.Relational.showWarnings&&typeof console!=="undefined"){console.warn("Relation=%o; collectionKey=%s already exists on collection=%o",this,i,this.options.collectionKey)}}else if(i){e[i]=this.instance}}this.listenTo(e,"relational:add",this.handleAddition).listenTo(e,"relational:remove",this.handleRemoval).listenTo(e,"relational:reset",this.handleReset);return e},findRelated:function(e){var r=null;e=n.defaults({parse:this.options.parse},e);if(this.keyContents instanceof t.Collection){this._prepareCollection(this.keyContents);r=this.keyContents}else{var i=[];n.each(this.keyContents,function(t){if(t instanceof this.relatedModel){var r=t}else{r=this.relatedModel.findOrCreate(t,n.extend({merge:true},e,{create:this.options.createModels}))}r&&i.push(r)},this);if(this.related instanceof t.Collection){r=this.related}else{r=this._prepareCollection()}r.set(i,n.defaults({merge:false,parse:false},e))}this.keyIds=n.difference(this.keyIds,n.pluck(r.models,"id"));return r},setKeyContents:function(e){this.keyContents=e instanceof t.Collection?e:null;this.keyIds=[];if(!this.keyContents&&(e||e===0)){this.keyContents=n.isArray(e)?e:[e];n.each(this.keyContents,function(e){var n=t.Relational.store.resolveIdForItem(this.relatedModel,e);if(n||n===0){this.keyIds.push(n)}},this)}},onChange:function(e,r,i){i=i?n.clone(i):{};this.setKeyContents(r);this.changed=false;var s=this.findRelated(i);this.setRelated(s);if(!i.silent){var o=this;t.Relational.eventQueue.add(function(){if(o.changed){o.instance.trigger("change:"+o.key,o.instance,o.related,i,true);o.changed=false}})}},handleAddition:function(e,r,i){i=i?n.clone(i):{};this.changed=true;n.each(this.getReverseRelations(e),function(e){e.addRelated(this.instance,i)},this);var s=this;!i.silent&&t.Relational.eventQueue.add(function(){s.instance.trigger("add:"+s.key,e,s.related,i)})},handleRemoval:function(e,r,i){i=i?n.clone(i):{};this.changed=true;n.each(this.getReverseRelations(e),function(e){e.removeRelated(this.instance,null,i)},this);var s=this;!i.silent&&t.Relational.eventQueue.add(function(){s.instance.trigger("remove:"+s.key,e,s.related,i)})},handleReset:function(e,r){var i=this;r=r?n.clone(r):{};!r.silent&&t.Relational.eventQueue.add(function(){i.instance.trigger("reset:"+i.key,i.related,r)})},tryAddRelated:function(e,t,r){var i=n.contains(this.keyIds,e.id);if(i){this.addRelated(e,r);this.keyIds=n.without(this.keyIds,e.id)}},addRelated:function(e,t){var r=this;e.queue(function(){if(r.related&&!r.related.get(e)){r.related.add(e,n.defaults({parse:false},t))}})},removeRelated:function(e,t,n){if(this.related.get(e)){this.related.remove(e,n)}}});t.RelationalModel=t.Model.extend({relations:null,_relations:null,_isInitialized:false,_deferProcessing:false,_queue:null,_attributeChangeFired:false,subModelTypeAttribute:"type",subModelTypes:null,constructor:function(e,r){if(r&&r.collection){var i=this,s=this.collection=r.collection;delete r.collection;this._deferProcessing=true;var o=function(e){if(e===i){i._deferProcessing=false;i.processQueue();s.off("relational:add",o)}};s.on("relational:add",o);n.defer(function(){o(i)})}t.Relational.store.processOrphanRelations();t.Relational.store.listenTo(this,"relational:unregister",t.Relational.store.unregister);this._queue=new t.BlockingQueue;this._queue.block();t.Relational.eventQueue.block();try{t.Model.apply(this,arguments)}finally{t.Relational.eventQueue.unblock()}},trigger:function(e){if(e.length>5&&e.indexOf("change")===0){var n=this,r=arguments;if(!t.Relational.eventQueue.isLocked()){t.Model.prototype.trigger.apply(n,r)}else{t.Relational.eventQueue.add(function(){var i=true;if(e==="change"){i=n.hasChanged()||n._attributeChangeFired;n._attributeChangeFired=false}else{var s=e.slice(7),o=n.getRelation(s);if(o){i=r[4]===true;if(i){n.changed[s]=r[2]}else if(!o.changed){delete n.changed[s]}}else if(i){n._attributeChangeFired=true}}i&&t.Model.prototype.trigger.apply(n,r)})}}else if(e==="destroy"){t.Model.prototype.trigger.apply(this,arguments);t.Relational.store.unregister(this)}else{t.Model.prototype.trigger.apply(this,arguments)}return this},initializeRelations:function(e){this.acquire();this._relations={};n.each(this.relations||[],function(n){t.Relational.store.initializeRelation(this,n,e)},this);this._isInitialized=true;this.release();this.processQueue()},updateRelations:function(e,t){if(this._isInitialized&&!this.isLocked()){n.each(this._relations,function(n){if(!e||n.keySource in e||n.key in e){var r=this.attributes[n.keySource]||this.attributes[n.key],i=e&&(e[n.keySource]||e[n.key]);if(n.related!==r||r===null&&i===null){this.trigger("relational:change:"+n.key,this,r,t||{})}}if(n.keySource!==n.key){delete this.attributes[n.keySource]}},this)}},queue:function(e){this._queue.add(e)},processQueue:function(){if(this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked()){this._queue.unblock()}},getRelation:function(e){return this._relations[e]},getRelations:function(){return n.values(this._relations)},fetchRelated:function(e,r,i){r=n.extend({update:true,remove:false},r);var s,o,u=[],a=this.getRelation(e),f=a&&(a.keyIds&&a.keyIds.slice(0)||(a.keyId||a.keyId===0?[a.keyId]:[]));if(i){s=a.related instanceof t.Collection?a.related.models:[a.related];n.each(s,function(e){if(e.id||e.id===0){f.push(e.id)}})}if(f&&f.length){var l=[];s=n.map(f,function(e){var t=a.relatedModel.findModel(e);if(!t){var n={};n[a.relatedModel.prototype.idAttribute]=e;t=a.relatedModel.findOrCreate(n,r);l.push(t)}return t},this);if(a.related instanceof t.Collection&&n.isFunction(a.related.url)){o=a.related.url(s)}if(o&&o!==a.related.url()){var c=n.defaults({error:function(){var e=arguments;n.each(l,function(t){t.trigger("destroy",t,t.collection,r);r.error&&r.error.apply(t,e)})},url:o},r);u=[a.related.fetch(c)]}else{u=n.map(s,function(e){var t=n.defaults({error:function(){if(n.contains(l,e)){e.trigger("destroy",e,e.collection,r);r.error&&r.error.apply(e,arguments)}}},r);return e.fetch(t)},this)}}return u},get:function(e){var r=t.Model.prototype.get.call(this,e);if(!this.dotNotation||e.indexOf(".")===-1){return r}var i=e.split(".");var s=n.reduce(i,function(e,r){if(n.isNull(e)||n.isUndefined(e)){return undefined}else if(e instanceof t.Model){return t.Model.prototype.get.call(e,r)}else if(e instanceof t.Collection){return t.Collection.prototype.at.call(e,r)}else{throw new Error("Attribute must be an instanceof Backbone.Model or Backbone.Collection. Is: "+e+", currentSplit: "+r)}},this);if(r!==undefined&&s!==undefined){throw new Error("Ambiguous result for '"+e+"'. direct result: "+r+", dotNotation: "+s)}return r||s},set:function(e,r,i){t.Relational.eventQueue.block();var s;if(n.isObject(e)||e==null){s=e;i=r}else{s={};s[e]=r}try{var o=this.id,u=s&&this.idAttribute in s&&s[this.idAttribute];t.Relational.store.checkId(this,u);var a=t.Model.prototype.set.apply(this,arguments);if(!this._isInitialized&&!this.isLocked()){this.constructor.initializeModelHierarchy();if(u||u===0){t.Relational.store.register(this)}this.initializeRelations(i)}else if(u&&u!==o){t.Relational.store.update(this)}if(s){this.updateRelations(s,i)}}finally{t.Relational.eventQueue.unblock()}return a},clone:function(){var e=n.clone(this.attributes);if(!n.isUndefined(e[this.idAttribute])){e[this.idAttribute]=null}n.each(this.getRelations(),function(t){delete e[t.key]});return new this.constructor(e)},toJSON:function(e){if(this.isLocked()){return this.id}this.acquire();var r=t.Model.prototype.toJSON.call(this,e);if(this.constructor._superModel&&!(this.constructor._subModelTypeAttribute in r)){r[this.constructor._subModelTypeAttribute]=this.constructor._subModelTypeValue}n.each(this._relations,function(i){var s=r[i.key],o=i.options.includeInJSON,u=null;if(o===true){if(s&&n.isFunction(s.toJSON)){u=s.toJSON(e)}}else if(n.isString(o)){if(s instanceof t.Collection){u=s.pluck(o)}else if(s instanceof t.Model){u=s.get(o)}if(o===i.relatedModel.prototype.idAttribute){if(i instanceof t.HasMany){u=u.concat(i.keyIds)}else if(i instanceof t.HasOne){u=u||i.keyId;if(!u&&!n.isObject(i.keyContents)){u=i.keyContents||null}}}}else if(n.isArray(o)){if(s instanceof t.Collection){u=[];s.each(function(e){var t={};n.each(o,function(n){t[n]=e.get(n)});u.push(t)})}else if(s instanceof t.Model){u={};n.each(o,function(e){u[e]=s.get(e)})}}else{delete r[i.key]}if(o){r[i.keyDestination]=u}if(i.keyDestination!==i.key){delete r[i.key]}});this.release();return r}},{setup:function(e){this.prototype.relations=(this.prototype.relations||[]).slice(0);this._subModels={};this._superModel=null;if(this.prototype.hasOwnProperty("subModelTypes")){t.Relational.store.addSubModels(this.prototype.subModelTypes,this)}else{this.prototype.subModelTypes=null}n.each(this.prototype.relations||[],function(e){if(!e.model){e.model=this}if(e.reverseRelation&&e.model===this){var r=true;if(n.isString(e.relatedModel)){var i=t.Relational.store.getObjectByName(e.relatedModel);r=i&&i.prototype instanceof t.RelationalModel}if(r){t.Relational.store.initializeRelation(null,e)}else if(n.isString(e.relatedModel)){t.Relational.store.addOrphanRelation(e)}}},this);return this},build:function(e,t){this.initializeModelHierarchy();var n=this._findSubModelType(this,e)||this;return new n(e,t)},_findSubModelType:function(e,t){if(e._subModels&&e.prototype.subModelTypeAttribute in t){var n=t[e.prototype.subModelTypeAttribute];var r=e._subModels[n];if(r){return r}else{for(n in e._subModels){r=this._findSubModelType(e._subModels[n],t);if(r){return r}}}}return null},initializeModelHierarchy:function(){this.inheritRelations();if(this.prototype.subModelTypes){var e=n.keys(this._subModels);var r=n.omit(this.prototype.subModelTypes,e);n.each(r,function(e){var n=t.Relational.store.getObjectByName(e);n&&n.initializeModelHierarchy()})}},inheritRelations:function(){if(!n.isUndefined(this._superModel)&&!n.isNull(this._superModel)){return}t.Relational.store.setupSuperModel(this);if(this._superModel){this._superModel.inheritRelations();if(this._superModel.prototype.relations){var e=n.filter(this._superModel.prototype.relations||[],function(e){return!n.any(this.prototype.relations||[],function(t){return e.relatedModel===t.relatedModel&&e.key===t.key},this)},this);this.prototype.relations=e.concat(this.prototype.relations)}}else{this._superModel=false}},findOrCreate:function(e,t){t||(t={});var r=n.isObject(e)&&t.parse&&this.prototype.parse?this.prototype.parse(n.clone(e)):e;var i=this.findModel(r);if(n.isObject(e)){if(i&&t.merge!==false){delete t.collection;delete t.url;i.set(r,t)}else if(!i&&t.create!==false){i=this.build(r,n.defaults({parse:false},t))}}return i},find:function(e,t){t||(t={});t.create=false;return this.findOrCreate(e,t)},findModel:function(e){return t.Relational.store.find(this,e)}});n.extend(t.RelationalModel.prototype,t.Semaphore);t.Collection.prototype.__prepareModel=t.Collection.prototype._prepareModel;t.Collection.prototype._prepareModel=function(e,r){var i;if(e instanceof t.Model){if(!e.collection){e.collection=this}i=e}else{r=r?n.clone(r):{};r.collection=this;if(typeof this.model.findOrCreate!=="undefined"){i=this.model.findOrCreate(e,r)}else{i=new this.model(e,r)}if(i&&i.validationError){this.trigger("invalid",this,e,r);i=false}}return i};var r=t.Collection.prototype.__set=t.Collection.prototype.set;t.Collection.prototype.set=function(e,i){if(!(this.model.prototype instanceof t.RelationalModel)){return r.apply(this,arguments)}if(i&&i.parse){e=this.parse(e,i)}var s=!n.isArray(e),o=[],u=[];e=s?e?[e]:[]:n.clone(e);n.each(e,function(e){if(!(e instanceof t.Model)){e=t.Collection.prototype._prepareModel.call(this,e,i)}if(e){u.push(e);if(!(this.get(e)||this.get(e.cid))){o.push(e)}else if(e.id!=null){this._byId[e.id]=e}}},this);u=s?u.length?u[0]:null:u;var a=r.call(this,u,n.defaults({parse:false},i));n.each(o,function(e){if(this.get(e)||this.get(e.cid)){this.trigger("relational:add",e,this,i)}},this);return a};var i=t.Collection.prototype.__remove=t.Collection.prototype.remove;t.Collection.prototype.remove=function(e,r){if(!(this.model.prototype instanceof t.RelationalModel)){return i.apply(this,arguments)}var s=!n.isArray(e),o=[];e=s?e?[e]:[]:n.clone(e);r||(r={});n.each(e,function(e){e=this.get(e)||e&&this.get(e.cid);e&&o.push(e)},this);var u=i.call(this,s?o.length?o[0]:null:o,r);n.each(o,function(e){this.trigger("relational:remove",e,this,r)},this);return u};var s=t.Collection.prototype.__reset=t.Collection.prototype.reset;t.Collection.prototype.reset=function(e,r){r=n.extend({merge:true},r);var i=s.call(this,e,r);if(this.model.prototype instanceof t.RelationalModel){this.trigger("relational:reset",this,r)}return i};var o=t.Collection.prototype.__sort=t.Collection.prototype.sort;t.Collection.prototype.sort=function(e){var n=o.call(this,e);if(this.model.prototype instanceof t.RelationalModel){this.trigger("relational:reset",this,e)}return n};var u=t.Collection.prototype.__trigger=t.Collection.prototype.trigger;t.Collection.prototype.trigger=function(e){if(!(this.model.prototype instanceof t.RelationalModel)){return u.apply(this,arguments)}if(e==="add"||e==="remove"||e==="reset"||e==="sort"){var r=this,i=arguments;if(n.isObject(i[3])){i=n.toArray(i);i[3]=n.clone(i[3])}t.Relational.eventQueue.add(function(){u.apply(r,i)})}else{u.apply(this,arguments)}return this};t.RelationalModel.extend=function(e,n){var r=t.Model.extend.apply(this,arguments);r.setup(this);return r}})
